name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  REGISTRY_NAME: dsmsacr
  NAMESPACE: demo-e2e
  APP_NAME: security-policy-app-dev
  RESOURCE_GROUP: az-pac-demo

jobs:
  dev:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Building the Docker image
      run: |
        docker build . --tag demo-e2e
    
    - uses: ds-ms/container-scan@releases/v0
      name: Container Scan
      id: imagescan
      continue-on-error: true
      with:
        image-name: demo-e2e
    
    - name: Docker login
      uses: azure/docker-login@v1
      if: github.event.ref == 'refs/heads/master'
      with:
        login-server: dsmsacr.azurecr.io
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Push image
      if: github.event.ref == 'refs/heads/master'
      run: |
        docker tag demo-e2e ${{ env.REGISTRY_NAME }}.azurecr.io/demo-e2e:${{ github.sha }}
        docker push ${{ env.REGISTRY_NAME }}.azurecr.io/demo-e2e:${{ github.sha }}

    - name: Upload Container Scan Report
      uses: github/codeql-action/upload-sarif@v1
      if: github.event.ref == 'refs/heads/master'
      with:
        sarif_file: ${{ steps.imagescan.outputs.sarif-file-path }}
    
    - name: Login to Azure
      if: github.event.ref == 'refs/heads/master'
      uses: azure/login@v1.1
      with:
        creds: ${{secrets.AZURE_CREDENTIALS}}
    
    - name: Set Web App ACR authentication
      if: github.event.ref == 'refs/heads/master'
      uses: Azure/appservice-settings@v1
      with:
        app-name: ${{ env.APP_NAME }}
        app-settings-json: |
          [
              {
                  "name": "DOCKER_REGISTRY_SERVER_PASSWORD",
                  "value": "${{ secrets.DOCKER_PASSWORD }}",
                  "slotSetting": false
              },
              {
                  "name": "DOCKER_REGISTRY_SERVER_URL",
                  "value": "${{ env.REGISTRY_NAME }}.azurecr.io",
                  "slotSetting": false
              },
              {
                  "name": "DOCKER_REGISTRY_SERVER_USERNAME",
                  "value": "${{ secrets.DOCKER_USERNAME  }}",
                  "slotSetting": false
              }
          ]
    
    - name: Configure
      if: github.event.ref == 'refs/heads/master'
      run: bash ./scripts/updateAppConfig.sh appConfig.json subscriptions/c00d16c7-6c1f-4c03-9be1-6934a4c49682/resourceGroups/${{ env.RESOURCE_GROUP }}/providers/Microsoft.Web/sites/${{ env.APP_NAME }}
    
    - name: Deploy
      if: github.event.ref == 'refs/heads/master'
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.APP_NAME }}
        images: ${{ env.REGISTRY_NAME }}.azurecr.io/demo-e2e:${{ github.sha }}
        
    - name: Upload Container Scan assessment to webapp
      if: github.event.ref == 'refs/heads/master'
      uses: ds-ms/asc-assessment@master
      with:
        assessment-title: Container Scan Results
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        web-app-name: ${{ env.APP_NAME }}
        resource-group: ${{ env.RESOURCE_GROUP }}

    - name: Check resource policy compliance post deployment
      if: github.event.ref == 'refs/heads/master'
      uses: ajinkya599/AzPac@azpac-initial
      with:
        scopes: /subscriptions/c00d16c7-6c1f-4c03-9be1-6934a4c49682/resourcegroups/${{ env.RESOURCE_GROUP }}/providers/Microsoft.Web/sites/${{ env.APP_NAME }}

  prod:
    if: github.event.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    needs: [dev]
    steps:
    - uses: actions/checkout@v2
    
    - name: Building the Docker image
      run: |
        docker build . --tag demo-e2e
    
    - uses: ds-ms/container-scan@releases/v0
      name: Container Scan
      id: imagescan
      continue-on-error: true
      with:
        image-name: demo-e2e
    
    - name: Docker login
      uses: azure/docker-login@v1
      with:
        login-server: dsmsacr.azurecr.io
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Push image
      run: |
        docker tag demo-e2e ${{ env.REGISTRY_NAME }}.azurecr.io/demo-e2e:${{ github.sha }}
        docker push ${{ env.REGISTRY_NAME }}.azurecr.io/demo-e2e:${{ github.sha }}

    - name: Upload Container Scan Report
      if: github.event.ref == 'refs/heads/master'
      with:
        sarif_file: ${{ steps.imagescan.outputs.sarif-file-path }}
    
    - name: Login to Azure
      uses: azure/login@v1.1
      with:
        creds: ${{secrets.AZURE_CREDENTIALS}}
    
    - name: Set Web App ACR authentication
      uses: Azure/appservice-settings@v1
      with:
        app-name: ${{ env.APP_NAME }}
        app-settings-json: |
          [
              {
                  "name": "DOCKER_REGISTRY_SERVER_PASSWORD",
                  "value": "${{ secrets.DOCKER_PASSWORD }}",
                  "slotSetting": false
              },
              {
                  "name": "DOCKER_REGISTRY_SERVER_URL",
                  "value": "${{ env.REGISTRY_NAME }}.azurecr.io",
                  "slotSetting": false
              },
              {
                  "name": "DOCKER_REGISTRY_SERVER_USERNAME",
                  "value": "${{ secrets.DOCKER_USERNAME  }}",
                  "slotSetting": false
              }
          ]
    
    - name: Configure
      run: bash ./scripts/updateAppConfig.sh appConfig.json subscriptions/c00d16c7-6c1f-4c03-9be1-6934a4c49682/resourceGroups/${{ env.RESOURCE_GROUP }}/providers/Microsoft.Web/sites/${{ env.APP_NAME }}
    
    - name: Deploy
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.APP_NAME }}
        images: ${{ env.REGISTRY_NAME }}.azurecr.io/demo-e2e:${{ github.sha }}
        
    - name: Upload Container Scan assessment to webapp
      uses: ds-ms/asc-assessment@master
      with:
        assessment-title: Container Scan Results
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        web-app-name: ${{ env.APP_NAME }}
        resource-group: ${{ env.RESOURCE_GROUP }}

    - name: Check resource policy compliance post deployment
      uses: ajinkya599/AzPac@azpac-initial
      with:
        scopes: /subscriptions/c00d16c7-6c1f-4c03-9be1-6934a4c49682/resourcegroups/${{ env.RESOURCE_GROUP }}/providers/Microsoft.Web/sites/${{ env.APP_NAME }}
  
